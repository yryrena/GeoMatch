# .github/workflows/ci.yml
name: ci

on:
  push:
    branches: [ main, chore/** ]
  pull_request:
    branches: [ main ]

jobs:
  ascii_guard:
    name: ascii guard
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      ## fail if any non-ascii byte appears in non-binary tracked files
      - name: fail on non-ascii
        shell: bash
        run: |
          set -euo pipefail
          fail=0
          ## iterate tracked files; skip binaries; grep bytes outside 0x20-0x7e
          while IFS= read -r -d '' f; do
            if file -I "$f" | grep -q 'charset=binary'; then
              continue
            fi
            if LC_ALL=C grep -n "[^ -~]" "$f" >/dev/null; then
              echo "non-ascii found in: $f"
              fail=1
            fi
          done < <(git ls-files -z)
          if [[ $fail -ne 0 ]]; then
            echo "ci failed: strip smart quotes / nbsp etc."
            exit 1
          fi

  julia_tests:
    name: julia tests
    runs-on: ubuntu-latest
    needs: ascii_guard
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: '1.11'
      - run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.test()'